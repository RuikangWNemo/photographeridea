<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ‘„å½±å¸ˆçµæ„Ÿå·¥å…·</title>
    <!-- CSS éƒ¨åˆ† -->
    <style>
        /* ========== å…¨å±€æ ·å¼ ========== */
        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            color: #fff;
            overflow-x: hidden;
            height: 100%;
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        /* åŠ¨æ€èƒŒæ™¯åŠ¨ç”» */
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* é»˜è®¤èƒŒæ™¯ */
        body {
            background: linear-gradient(-45deg, #a1c4fd, #c2e9fb, #a1c4fd, #c2e9fb);
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            border: none;
            padding: 10px 20px;
            color: #fff;
            font-size: 1em;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.5s;
            margin: 5px;
        }

        .btn-blue {
            background: linear-gradient(45deg, #36d1dc, #5b86e5);
        }

        .btn-blue:hover {
            background: linear-gradient(45deg, #5b86e5, #36d1dc);
        }

        .btn-green {
            background: linear-gradient(45deg, #11998e, #38ef7d);
        }

        .btn-green:hover {
            background: linear-gradient(45deg, #38ef7d, #11998e);
        }

        /* å…¶ä»–æ ·å¼ */
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding-top: 20px;
        }

        h1 {
            text-align: center;
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        #location-name {
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 20px;
        }

        .location-controls {
            text-align: center;
            margin-bottom: 10px;
        }

        #location-input {
            padding: 5px;
            font-size: 1em;
            width: 200px;
        }

        #map {
            height: 300px;
            margin-bottom: 20px;
        }

        /* å¤©æ°”ä¿¡æ¯æ¨¡å— */
        .weather-info {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }

        .weather-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border-radius: 15px;
            padding: 20px;
            margin: 10px;
            flex: 1 1 500px;
            position: relative;
            overflow: hidden;
            transition: background-color 0.3s, transform 0.3s;
        }

        .weather-card:hover {
            transform: translateY(-10px);
        }

        .weather-card h2 {
            margin-top: 0;
            font-size: 1.5em;
        }

        .weather-icon {
            font-size: 4em;
            margin-bottom: 10px;
        }

        .temp {
            font-size: 2.5em;
            font-weight: bold;
        }

        .details {
            font-size: 1em;
            margin-top: 10px;
        }

        /* æ—¥å‡ºæ—¥è½æ¨¡å—å†…éƒ¨å¸ƒå±€ */
        .sun-content {
            display: flex;
        }

        #sunrise-sunset {
            flex: 1;
        }

        #sun-map {
            flex: 1;
            margin-left: 20px;
            height: 200px;
        }

        /* å°æ—¶å¤©æ°”é¢„æŠ¥ */
        .hourly-forecast {
            margin-bottom: 40px;
        }

        .hourly-forecast h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        .hourly-cards {
            display: flex;
            overflow-x: auto;
        }

        .hourly-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin: 5px;
            border-radius: 10px;
            min-width: 80px;
            text-align: center;
            transition: transform 0.3s;
        }

        .hourly-card:hover {
            transform: translateY(-10px);
        }

        .hourly-card h3 {
            margin: 10px 0;
            font-size: 1em;
        }

        .hourly-card .icon {
            font-size: 2em;
            margin-bottom: 5px;
        }

        /* æœªæ¥7å¤©å¤©æ°”é¢„æŠ¥ */
        .daily-forecast {
            margin-bottom: 40px;
        }

        .daily-forecast h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        .daily-cards {
            display: flex;
            overflow-x: auto;
        }

        .daily-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin: 5px;
            border-radius: 10px;
            min-width: 100px;
            text-align: center;
            transition: transform 0.3s;
            cursor: pointer;
        }

        .daily-card:hover {
            transform: translateY(-10px);
        }

        .daily-card h3 {
            margin: 10px 0;
            font-size: 1em;
        }

        .daily-card .icon {
            font-size: 2em;
            margin-bottom: 5px;
        }

        /* çµæ„Ÿç”Ÿæˆæ¨¡å— */
        .inspiration {
            text-align: center;
            margin-bottom: 50px;
        }

        .category-select {
            margin-bottom: 20px;
        }

        .category-select select {
            padding: 10px;
            font-size: 1em;
            border: none;
            border-radius: 20px;
        }

        .generate-btn {
            background: linear-gradient(45deg, #ff512f, #dd2476);
            border: none;
            padding: 15px 30px;
            color: #fff;
            font-size: 1.5em;
            border-radius: 30px;
            cursor: pointer;
            transition: background 0.5s;
            position: relative;
            overflow: hidden;
        }

        .generate-btn:hover {
            background: linear-gradient(45deg, #dd2476, #ff512f);
        }

        .dice {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            animation: rotateDice 1s forwards;
            display: none;
            z-index: 9999;
        }

        @keyframes rotateDice {
            0% { opacity: 0; transform: translate(-50%, -50%) rotate(0deg) scale(1); }
            50% { opacity: 1; transform: translate(-50%, -50%) rotate(360deg) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) rotate(720deg) scale(1); }
        }

        .inspiration-text {
            margin-top: 30px;
            font-size: 1.5em;
            min-height: 50px;
            position: relative;
        }

        .inspiration-text textarea {
            width: 80%;
            max-width: 800px;
            height: 100px;
            font-size: 1em;
            padding: 10px;
            border: none;
            border-radius: 10px;
            resize: none;
            transition: box-shadow 0.3s;
        }

        .inspiration-text textarea:focus {
            outline: none;
            box-shadow: 0 0 10px #ff512f;
        }

        .text-glow {
            box-shadow: 0 0 20px #ff512f !important;
        }

        /* æ”¶è—åˆ—è¡¨ */
        .saved-inspirations {
            max-width: 800px;
            margin: 0 auto;
        }

        .saved-inspirations h3 {
            text-align: center;
            margin-bottom: 20px;
        }

        .inspiration-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            position: relative;
            opacity: 1;
            transition: opacity 0.5s;
        }

        .inspiration-item.fade-out {
            opacity: 0;
        }

        .inspiration-item.fade-in {
            opacity: 0;
        }

        .inspiration-item.fade-in.show {
            opacity: 1;
        }

        .inspiration-item button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            border: none;
            padding: 5px 10px;
            color: #fff;
            font-size: 0.9em;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .inspiration-item button:hover {
            background: #c82333;
        }

        /* ç…§ç‰‡å±•ç¤ºåŒºåŸŸ */
        .photo-gallery {
            margin: 20px 0;
        }

        .photo-gallery h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        #photo-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }

        #photo-container img {
            margin: 5px;
            width: 200px;
            height: auto;
            border-radius: 10px;
            transition: transform 0.3s;
        }

        #photo-container img:hover {
            transform: scale(1.05);
        }

        /* åŠ è½½æŒ‡ç¤ºå™¨æ ·å¼ */
        #photo-container p {
            color: #fff;
            text-align: center;
            font-size: 1.2em;
            width: 100%;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }
            .generate-btn {
                font-size: 1.2em;
            }
            .inspiration-text textarea {
                width: 100%;
            }
            .weather-info, .hourly-forecast, .daily-forecast {
                flex-direction: column;
                align-items: center;
            }
            .weather-card, .hourly-card, .daily-card {
                flex: 1 1 100%;
            }
            .sun-content {
                flex-direction: column;
            }
            #sun-map {
                margin-left: 0;
                margin-top: 20px;
                height: 200px;
            }
            #map {
                height: 200px;
            }
        }
    </style>
    <!-- å¼•å…¥Leafletåœ°å›¾CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>

<div class="container">
    <h1>æ‘„å½±å¸ˆçµæ„Ÿå·¥å…·</h1>

    <!-- åœ°ç‚¹æ˜¾ç¤º -->
    <div id="location-name">åœ°ç‚¹ï¼šæœªçŸ¥</div>

    <!-- åœ°ç‚¹è¾“å…¥å’ŒæŒ‰é’® -->
    <div class="location-controls">
        <input type="text" id="location-input" placeholder="è¾“å…¥åœ°ç‚¹åç§°">
        <button id="search-location-btn" class="btn btn-blue">æœç´¢åœ°ç‚¹</button>
        <button id="current-location-btn" class="btn btn-green">å›åˆ°å½“å‰ä½ç½®</button>
    </div>

    <!-- åœ°å›¾å®¹å™¨ -->
    <div id="map"></div>

    <!-- å¤©æ°”ä¿¡æ¯æ¨¡å— -->
    <div class="weather-info">
        <div class="weather-card" id="current-weather">
            <div class="weather-icon" id="weather-icon">â˜€ï¸</div>
            <h2 id="weather-description">æ™´å¤©</h2>
            <div class="temp" id="temperature">25â„ƒ</div>
            <div class="details" id="weather-details">
                é£é€Ÿï¼š5 m/s<br>
                æ¹¿åº¦ï¼š60%<br>
                äº‘é‡ï¼š20%
            </div>
        </div>
        <div class="weather-card" id="sun-times">
            <h2>æ—¥å‡ºæ—¥è½</h2>
            <div class="sun-content">
                <div class="details" id="sunrise-sunset">
                    æ—¥å‡ºæ—¶é—´ï¼š6:00 AM<br>
                    æ—¥è½æ—¶é—´ï¼š6:00 PM<br>
                    é»„é‡‘æ—¶æ®µï¼š5:30 AM - 6:30 AM<br>
                    è“è°ƒæ—¶æ®µï¼š6:30 PM - 7:00 PM
                </div>
                <div id="sun-map"></div>
            </div>
        </div>
    </div>

    <!-- å°æ—¶å¤©æ°”é¢„æŠ¥ -->
    <div class="hourly-forecast">
        <h2>å°æ—¶å¤©æ°”é¢„æŠ¥</h2>
        <div class="hourly-cards" id="hourly-forecast">
            <!-- åŠ¨æ€ç”Ÿæˆçš„å°æ—¶é¢„æŠ¥å¡ç‰‡ -->
        </div>
    </div>

    <!-- æœªæ¥7å¤©å¤©æ°”é¢„æŠ¥ -->
    <div class="daily-forecast">
        <h2>æœªæ¥7å¤©å¤©æ°”é¢„æŠ¥</h2>
        <div class="daily-cards" id="daily-forecast">
            <!-- åŠ¨æ€ç”Ÿæˆçš„æ¯æ—¥é¢„æŠ¥å¡ç‰‡ -->
        </div>
    </div>

    <!-- çµæ„Ÿç”Ÿæˆæ¨¡å— -->
    <div class="inspiration">
        <div class="category-select">
            <select id="category-select">
                <option value="all">ä¸é™åˆ†ç±»</option>
                <option value="äººæ–‡">äººæ–‡</option>
                <option value="è‡ªç„¶">è‡ªç„¶</option>
                <option value="æŠ½è±¡">æŠ½è±¡</option>
                <option value="è¡—å¤´">è¡—å¤´</option>
            </select>
        </div>
        <button class="generate-btn" id="generate-btn">
            å¯»æ‰¾çµæ„Ÿ
            <div class="dice" id="dice">ğŸ²</div>
        </button>
        <div class="inspiration-text" id="inspiration-text">
            <textarea id="inspiration-input" placeholder="ç‚¹å‡»'å¯»æ‰¾çµæ„Ÿ'æŒ‰é’®ï¼Œè·å–æ–°çš„çµæ„Ÿ..."></textarea>
        </div>
        <button class="btn btn-green" id="save-btn">æ”¶è—çµæ„Ÿ</button>
    </div>

    <!-- æ”¶è—çš„çµæ„Ÿåˆ—è¡¨ -->
    <div class="saved-inspirations" id="saved-inspirations">
        <h3>å·²æ”¶è—çš„çµæ„Ÿ</h3>
        <!-- åŠ¨æ€ç”Ÿæˆçš„æ”¶è—é¡¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
    </div>

    <!-- ç…§ç‰‡å±•ç¤ºåŒºåŸŸ -->
    <div class="photo-gallery">
        <h2>ç›®çš„åœ°ç…§ç‰‡</h2>
        <div id="photo-container">
            <!-- åŠ¨æ€åŠ è½½çš„ç…§ç‰‡ -->
        </div>
    </div>
</div>

<!-- å¼•å…¥Leafletåœ°å›¾JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    /* ========== å…¨å±€å˜é‡ ========== */

    const unsplashAccessKey = 'zXoGlnFIT1ybv0dYJJqkwo0zwm4FMtJ6ApsIHnFGEwg'; // è¯·æ›¿æ¢ä¸ºæ‚¨çš„ Unsplash API Access Key

    // å®šä¹‰çµæ„Ÿè¯æ±‡æ•°æ®
    const inspirationsData = {
        "äººæ–‡": {
            subjects: ['è¡Œäºº', 'è€äºº', 'å­©å­', 'æƒ…ä¾£', 'è¡—å¤´è‰ºäºº', 'å·¥äºº', 'å•†äºº', 'æ¸¸å®¢', 'å­¦ç”Ÿ', 'è€å¸ˆ', 'è‰ºæœ¯å®¶', 'èˆè€…', 'éŸ³ä¹å®¶', 'è¿åŠ¨å‘˜', 'æ‘„å½±å¸ˆ', 'å¸æœº', 'åŒ»ç”Ÿ', 'æŠ¤å£«', 'æœåŠ¡å‘˜', 'å¨å¸ˆ'],
            actions: ['è¡Œèµ°', 'å‡è§†', 'ç­‰å¾…', 'äº¤è°ˆ', 'å¾®ç¬‘', 'è·³èˆ', 'é˜…è¯»', 'å·¥ä½œ', 'ä¼‘æ¯', 'è´­ç‰©', 'å”±æ­Œ', 'è¡¨æ¼”', 'æ—…è¡Œ', 'æ‹ç…§', 'ç»˜ç”»', 'å†¥æƒ³', 'é”»ç‚¼', 'å¥”è·‘', 'ç©è€', 'èšä¼š'],
            scenes: ['è¡—é“', 'å…¬å›­', 'å’–å•¡é¦†', 'åœ°é“ç«™', 'å¹¿åœº', 'å¸‚åœº', 'æ ¡å›­', 'è½¦ç«™', 'æœºåœº', 'ç å¤´', 'æ•™å ‚', 'åšç‰©é¦†', 'å‰§é™¢', 'é¤å…', 'é…’åº—', 'å•†åœº', 'æµ·æ»©', 'å±±é¡¶', 'æ¸¸ä¹å›­', 'å›¾ä¹¦é¦†'],
            descriptors: ['é˜³å…‰ä¸‹', 'é›¨ä¸­', 'é»„æ˜æ—¶', 'æ¸…æ™¨', 'å¤œæ™š', 'éœ“è™¹ç¯ä¸‹', 'å€’å½±ä¸­', 'å‰ªå½±', 'èƒŒå…‰', 'äººç¾¤ä¸­', 'ç‹¬è‡ª', 'èƒŒå½±', 'ç¬‘å®¹', 'ä¾§è„¸', 'èƒŒåŒ…', 'ç‰µæ‰‹', 'äº²å»', 'æ‹¥æŠ±', 'å¥”è·‘', 'è·³è·ƒ'],
        },
        "è‡ªç„¶": {
            subjects: ['æ ‘æœ¨', 'èŠ±æœµ', 'å±±å³°', 'æ²³æµ', 'æ¹–æ³Š', 'æµ·æ´‹', 'å¤©ç©º', 'äº‘æœµ', 'åŠ¨ç‰©', 'é¸Ÿç±»', 'ç€‘å¸ƒ', 'æ²™æ¼ ', 'è‰åŸ', 'å†°å·', 'å²©çŸ³', 'æ˜Ÿç©º', 'æ—¥å‡º', 'æ—¥è½', 'å½©è™¹', 'æœˆäº®'],
            actions: ['æ‘‡æ›³', 'ç»½æ”¾', 'è€¸ç«‹', 'æµæ·Œ', 'é™æ­¢', 'æ³¢åŠ¨', 'é£˜åŠ¨', 'é£ç¿”', 'æ –æ¯', 'è§…é£Ÿ', 'å¥”è·‘', 'è·³è·ƒ', 'ç¡è§‰', 'æ•çŒ', 'çˆ¬è¡Œ', 'é¸£å«', 'æ¸¸æ³³', 'èº²è—', 'æ‰“æ–—', 'åˆä½œ'],
            scenes: ['æ£®æ—', 'è‰åŸ', 'æ²™æ¼ ', 'æµ·æ»©', 'å±±è°·', 'ç€‘å¸ƒ', 'æ´ç©´', 'æ²¼æ³½', 'å³¡è°·', 'å†°å·', 'æ¹–ç•”', 'æ²³è¾¹', 'å±±é¡¶', 'æµ·é¢', 'æ˜Ÿç©ºä¸‹', 'äº‘å±‚ä¸­', 'é›ªåœ°', 'ç«å±±', 'å²©çŸ³', 'æ‚¬å´–'],
            descriptors: ['æ—¥å‡ºæ—¶', 'æ—¥è½æ—¶', 'æ˜Ÿç©ºä¸‹', 'é›¾ä¸­', 'é£ä¸­', 'é›¨å', 'é›ªä¸­', 'å½©è™¹ä¸‹', 'æ™¨å…‰ä¸­', 'æš®è‰²é‡Œ', 'å€’å½±ä¸­', 'å¤œæ™š', 'æ¸…æ™¨', 'é»„æ˜', 'æ™´å¤©', 'é˜´å¤©', 'æš´é£é›¨', 'æ™´æœ—', 'å¤šäº‘', 'å¯’å†·'],
        },
        "æŠ½è±¡": {
            subjects: ['å½±å­', 'å…‰çº¿', 'è‰²å½©', 'çº¹ç†', 'å½¢çŠ¶', 'åå°„', 'å€’å½±', 'çº¿æ¡', 'å¯¹ç§°', 'è§’åº¦', 'å‰ªå½±', 'æ¨¡ç³Š', 'ç„¦ç‚¹', 'é€è§†', 'ç©ºé—´', 'å…‰å½±', 'æ˜æš—', 'è´¨æ„Ÿ', 'æ„å›¾', 'è´Ÿç©ºé—´'],
            actions: ['äº¤ç»‡', 'äº¤é”™', 'é‡å ', 'å»¶ä¼¸', 'èšç„¦', 'æ•£å°„', 'æ‰­æ›²', 'æ—‹è½¬', 'åè½¬', 'é‡å¤', 'æ’åˆ—', 'å †å ', 'å åŠ ', 'æŠ˜å°„', 'åå°„', 'å˜å½¢', 'èåˆ', 'åˆ†ç¦»', 'å¯¹æ¯”', 'æ¸å˜'],
            scenes: ['å¢™é¢', 'ç»ç’ƒ', 'æ°´é¢', 'é‡‘å±', 'çŸ³å¤´', 'å»ºç­‘', 'å¤©ç©º', 'åœ°é¢', 'è·¯é¢', 'çº¹ç†', 'å›¾æ¡ˆ', 'ç»†èŠ‚', 'çº¹è·¯', 'ç»“æ„', 'æè´¨', 'å…‰å½±', 'é¢œè‰²', 'å½¢çŠ¶', 'çº¿æ¡', 'æ›²çº¿'],
            descriptors: ['è¿‘è·ç¦»', 'ç‰¹å†™', 'é«˜è§’åº¦', 'ä½è§’åº¦', 'ä¿¯è§†', 'ä»°è§†', 'å±€éƒ¨', 'æ•´ä½“', 'å¯¹æ¯”', 'å’Œè°', 'å†·è‰²è°ƒ', 'æš–è‰²è°ƒ', 'é»‘ç™½', 'å½©è‰²', 'æŸ”å’Œ', 'å¼ºçƒˆ', 'ç®€æ´', 'å¤æ‚', 'åŠ¨æ€', 'é™æ€'],
        },
        "è¡—å¤´": {
            subjects: ['è¡Œäºº', 'è½¦è¾†', 'è·¯ç‰Œ', 'å»ºç­‘ç‰©', 'æ©±çª—', 'æ¶‚é¸¦', 'è¡—å¤´è‰ºäºº', 'å® ç‰©', 'åº—é“º', 'å…¬äº¤è½¦', 'åœ°é“', 'è‡ªè¡Œè½¦', 'æ‘©æ‰˜è½¦', 'å•†è´©', 'é¡¾å®¢', 'å¿«é€’å‘˜', 'è­¦å¯Ÿ', 'æ¶ˆé˜²å‘˜', 'åƒåœ¾æ¡¶', 'ç”µè¯äº­'],
            actions: ['è¡Œèµ°', 'åœç•™', 'äº¤è°ˆ', 'ç­‰å¾…', 'è¡¨æ¼”', 'è´­ç‰©', 'å·¥ä½œ', 'å¥”è·‘', 'ä¼‘æ¯', 'è§‚å¯Ÿ', 'æ‹ç…§', 'å”±æ­Œ', 'å¼¹å¥', 'ç»˜ç”»', 'ç»´ä¿®', 'æ¸…æ´', 'å·¡é€»', 'é€è´§', 'æ”¶é›†', 'äº¤æ˜“'],
            scenes: ['è¡—è§’', 'å··å­', 'å¹¿åœº', 'å¤©æ¡¥', 'åœ°é“ç«™', 'å…¬äº¤ç«™', 'å•†åœº', 'å¸‚åœº', 'å…¬å›­', 'å’–å•¡é¦†', 'é¤å…', 'å¤œå¸‚', 'æ­¥è¡Œè¡—', 'ç å¤´', 'æ¡¥ä¸Š', 'éš§é“', 'è½¦ç«™', 'åœè½¦åœº', 'å±…æ°‘åŒº', 'é«˜æ¥¼'],
            descriptors: ['å¤œæ™š', 'æ¸…æ™¨', 'é»„æ˜', 'é›¨ä¸­', 'é›ªä¸­', 'é›¾ä¸­', 'é˜³å…‰ä¸‹', 'é˜´å¤©', 'éœ“è™¹ç¯ä¸‹', 'äººç¾¤ä¸­', 'ç¹å¿™', 'å®é™', 'å–§é—¹', 'å­¤ç‹¬', 'æ¬¢ä¹', 'åŒ†å¿™', 'æ‚ é—²', 'çƒ­é—¹', 'å®‰é™', 'ç¯å…‰'],
        }
    };

    // æ”¶è—çš„çµæ„Ÿåˆ—è¡¨
    let savedInspirations = [];

    // ä½ç½®å˜é‡
    let lat, lon;

    // å°æ—¶å¤©æ°”æ•°æ®
    let hourlyData = {};

    // æ—¥å‡ºæ—¥è½æ—¶é—´
    let sunriseTime, sunsetTime;

    // å½“å‰æ—¶é—´æ®µ
    let timePeriod = 'day'; // 'day', 'night', 'golden', 'blue'

    // ========== è·å–DOMå…ƒç´  ==========

    // æ—¶é—´å’Œå¤©æ°”ç›¸å…³
    const weatherIcon = document.getElementById('weather-icon');
    const weatherDescription = document.getElementById('weather-description');
    const temperature = document.getElementById('temperature');
    const weatherDetails = document.getElementById('weather-details');
    const sunriseSunset = document.getElementById('sunrise-sunset');

    // åœ°ç‚¹æ˜¾ç¤º
    const locationNameElem = document.getElementById('location-name');

    // å°æ—¶å¤©æ°”é¢„æŠ¥
    const hourlyForecastDiv = document.getElementById('hourly-forecast');

    // æœªæ¥å¤©æ°”é¢„æŠ¥
    const dailyForecastDiv = document.getElementById('daily-forecast');

    // çµæ„Ÿç”Ÿæˆç›¸å…³
    const generateBtn = document.getElementById('generate-btn');
    const inspirationText = document.getElementById('inspiration-text');
    const saveBtn = document.getElementById('save-btn');
    const savedInspirationsDiv = document.getElementById('saved-inspirations');
    const categorySelect = document.getElementById('category-select');
    const dice = document.getElementById('dice');

    // åœ°å›¾ç›¸å…³
    let map;
    let marker;

    // ========== åˆå§‹åŒ– ==========

    window.onload = function() {
        loadSavedInspirations(); // åŠ è½½å·²ä¿å­˜çš„çµæ„Ÿ
        adjustWeatherCardBackground('æ™´å¤©'); // è®¾ç½®é»˜è®¤èƒŒæ™¯ä¸ºç™½å¤©èƒŒæ™¯
        initLocation(); // åˆå§‹åŒ–åœ°ç†ä½ç½®
    };

    // ========== åœ°ç†ä½ç½®ç›¸å…³å‡½æ•° ==========

    // åˆå§‹åŒ–åœ°ç†ä½ç½®
    function initLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                lat = position.coords.latitude;
                lon = position.coords.longitude;
                updateAllData();
            }, error => {
                alert('æ— æ³•è·å–æ‚¨çš„ä½ç½®ä¿¡æ¯ï¼Œè¯·ç¡®ä¿å·²å¼€å¯å®šä½æƒé™ã€‚');
                lat = 0;
                lon = 0;
                updateAllData();
            });
        } else {
            alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½åŠŸèƒ½ã€‚');
            lat = 0;
            lon = 0;
            updateAllData();
        }
    }

    // æ›´æ–°æ‰€æœ‰æ•°æ®
    function updateAllData() {
        getLocationName(lat, lon);
        getWeatherData(lat, lon);
        getSunTimes(lat, lon);
        if (map) {
            map.setView([lat, lon], 13);
            marker.setLatLng([lat, lon]);
        } else {
            initMap();
        }
    }

    // è·å–åœ°ç‚¹åç§°
    function getLocationName(lat, lon) {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`)
            .then(response => response.json())
            .then(data => {
                const locationName = data.address.city || data.address.town || data.address.village || data.address.country;
                locationNameElem.innerText = `åœ°ç‚¹ï¼š${locationName}`;
                loadLocationPhotos(locationName); // åŠ è½½ä½ç½®ç…§ç‰‡
            })
            .catch(error => {
                console.error('è·å–åœ°ç‚¹åç§°å¤±è´¥ï¼š', error);
            });
    }

    // ========== åœ°å›¾ç›¸å…³å‡½æ•° ==========

    // åˆå§‹åŒ–åœ°å›¾
    function initMap() {
        map = L.map('map').setView([lat, lon], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // æ·»åŠ å¯æ‹–åŠ¨çš„ Markerï¼ˆè“ç‚¹ï¼‰
        marker = L.marker([lat, lon], { draggable: true }).addTo(map);

        // ç›‘å¬ Marker æ‹–åŠ¨ç»“æŸäº‹ä»¶
        marker.on('dragend', function(e) {
            let position = e.target.getLatLng();
            lat = position.lat;
            lon = position.lng;
            updateAllData();
        });

        // ç›‘å¬åœ°å›¾ç‚¹å‡»äº‹ä»¶
        map.on('click', function(e) {
            lat = e.latlng.lat;
            lon = e.latlng.lng;
            marker.setLatLng(e.latlng);
            updateAllData();
        });
    }

    // åœ°ç‚¹æœç´¢åŠŸèƒ½
    document.getElementById('search-location-btn').addEventListener('click', function() {
        let locationName = document.getElementById('location-input').value;
        if (locationName) {
            // ä½¿ç”¨åœ°ç†ç¼–ç  API è·å–ä½ç½®
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationName)}`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        lat = parseFloat(data[0].lat);
                        lon = parseFloat(data[0].lon);
                        map.setView([lat, lon], 13);
                        marker.setLatLng([lat, lon]);
                        updateAllData();
                    } else {
                        alert('æœªæ‰¾åˆ°è¯¥åœ°ç‚¹ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚');
                    }
                })
                .catch(error => {
                    console.error('åœ°ç†ç¼–ç å¤±è´¥ï¼š', error);
                });
        }
    });

    // å›åˆ°å½“å‰ä½ç½®åŠŸèƒ½
    document.getElementById('current-location-btn').addEventListener('click', function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                lat = position.coords.latitude;
                lon = position.coords.longitude;
                map.setView([lat, lon], 13);
                marker.setLatLng([lat, lon]);
                updateAllData();
            }, error => {
                alert('æ— æ³•è·å–æ‚¨çš„ä½ç½®ä¿¡æ¯ã€‚');
            });
        } else {
            alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½åŠŸèƒ½ã€‚');
        }
    });

    // ========== å¤©æ°”ç›¸å…³å‡½æ•° ==========

    // è·å–å¤©æ°”æ•°æ®
    function getWeatherData(lat, lon) {
        fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,cloudcover,relativehumidity_2m,windspeed_10m,weathercode&daily=temperature_2m_max,temperature_2m_min,weathercode,sunrise,sunset,cloudcover_mean&timezone=auto`)
            .then(response => response.json())
            .then(data => {
                const weather = data.current_weather;
                const temp = weather.temperature;
                const windSpeed = weather.windspeed;
                const weatherCode = weather.weathercode;
                const humidity = data.hourly.relativehumidity_2m[0];
                const cloudCover = data.hourly.cloudcover[0];

                // æ›´æ–°å½“å‰å¤©æ°”
                updateWeatherUI(temp, windSpeed, humidity, cloudCover, weatherCode);

                // ä¿å­˜å°æ—¶æ•°æ®
                hourlyData = data.hourly;

                // æ›´æ–°å°æ—¶å¤©æ°”é¢„æŠ¥
                updateHourlyForecast(hourlyData, new Date()); // ä¼ å…¥å½“å‰æ—¥æœŸ

                // æ›´æ–°æ¯æ—¥å¤©æ°”é¢„æŠ¥
                updateDailyForecast(data.daily);
            })
            .catch(error => {
                console.error('è·å–å¤©æ°”æ•°æ®å¤±è´¥ï¼š', error);
            });
    }

    // æ›´æ–°å¤©æ°”ä¿¡æ¯UI
    function updateWeatherUI(temp, windSpeed, humidity, cloudCover, weatherCode) {
        temperature.innerText = `${temp}â„ƒ`;
        weatherDetails.innerHTML = `é£é€Ÿï¼š${windSpeed} m/s<br>æ¹¿åº¦ï¼š${humidity}%<br>äº‘é‡ï¼š${cloudCover}%`;

        // æ ¹æ®å¤©æ°”ä»£ç æ›´æ–°å›¾æ ‡å’Œæè¿°
        let { icon, description } = getWeatherIconAndDescription(weatherCode);
        weatherIcon.innerText = icon;
        weatherDescription.innerText = description;

        // æ ¹æ®æ—¶é—´æ®µè°ƒæ•´å¤©æ°”æ¨¡å—èƒŒæ™¯é¢œè‰²
        adjustWeatherCardBackground(description);
    }

    // è·å–å¤©æ°”å›¾æ ‡å’Œæè¿°
    function getWeatherIconAndDescription(weatherCode) {
        let icon = 'â˜€ï¸';
        let description = 'æ™´å¤©';

        if (weatherCode === 0) {
            icon = 'â˜€ï¸';
            description = 'æ™´å¤©';
        } else if (weatherCode >= 1 && weatherCode <= 3) {
            icon = 'ğŸŒ¤ï¸';
            description = 'å¤šäº‘';
        } else if (weatherCode >= 45 && weatherCode <= 48) {
            icon = 'ğŸŒ«ï¸';
            description = 'æœ‰é›¾';
        } else if (weatherCode >= 51 && weatherCode <= 67) {
            icon = 'ğŸŒ§ï¸';
            description = 'å°é›¨';
        } else if (weatherCode >= 71 && weatherCode <= 77) {
            icon = 'â„ï¸';
            description = 'ä¸‹é›ª';
        } else if (weatherCode >= 80 && weatherCode <= 86) {
            icon = 'ğŸŒ¦ï¸';
            description = 'é˜µé›¨';
        } else if (weatherCode >= 95 && weatherCode <= 99) {
            icon = 'â›ˆï¸';
            description = 'é›·é›¨';
        }

        return { icon, description };
    }

    // è°ƒæ•´å¤©æ°”æ¨¡å—èƒŒæ™¯é¢œè‰²
    function adjustWeatherCardBackground(weatherDescription) {
        // ä¿ç•™èƒŒæ™¯åŠ¨ç”»å±æ€§
        document.body.style.backgroundSize = '400% 400%';
        document.body.style.animation = 'gradientBG 15s ease infinite';

        if (timePeriod === 'golden') {
            document.body.style.background = 'linear-gradient(-45deg, #FFD194, #D1913C, #FFD194, #D1913C)';
        } else if (timePeriod === 'blue') {
            document.body.style.background = 'linear-gradient(-45deg, #141E30, #243B55, #141E30, #243B55)';
        } else if (timePeriod === 'night') {
            document.body.style.background = 'linear-gradient(-45deg, #0f2027, #2c5364, #0f2027, #2c5364)';
        } else {
            if (weatherDescription === 'æ™´å¤©') {
                document.body.style.background = 'linear-gradient(-45deg, #a1c4fd, #c2e9fb, #a1c4fd, #c2e9fb)';
            } else if (weatherDescription === 'å¤šäº‘') {
                document.body.style.background = 'linear-gradient(-45deg, #bdc3c7, #2c3e50, #bdc3c7, #2c3e50)';
            } else if (weatherDescription.includes('é›¨')) {
                document.body.style.background = 'linear-gradient(-45deg, #667db6, #0082c8, #667db6, #0082c8)';
            } else {
                document.body.style.background = 'linear-gradient(-45deg, #a1c4fd, #c2e9fb, #a1c4fd, #c2e9fb)';
            }
        }
    }

    // æ›´æ–°å°æ—¶å¤©æ°”é¢„æŠ¥
    function updateHourlyForecast(hourly, date = new Date()) {
        hourlyForecastDiv.innerHTML = '';
        const dateStr = `${date.getFullYear()}-${formatNumber(date.getMonth() + 1)}-${formatNumber(date.getDate())}`;
        for (let i = 0; i < hourly.time.length; i++) {
            if (hourly.time[i].startsWith(dateStr)) {
                const card = document.createElement('div');
                card.className = 'hourly-card';
                const time = new Date(hourly.time[i]);
                const temp = hourly.temperature_2m[i];
                const code = hourly.weathercode[i];
                const icon = getWeatherIconAndDescription(code).icon;
                card.innerHTML = `
                    <h3>${formatNumber(time.getHours())}:00</h3>
                    <div class="icon">${icon}</div>
                    <div>${temp}â„ƒ</div>
                `;
                hourlyForecastDiv.appendChild(card);
            }
        }
    }

    // æ›´æ–°æ¯æ—¥å¤©æ°”é¢„æŠ¥
    function updateDailyForecast(daily) {
        dailyForecastDiv.innerHTML = '';
        for (let i = 0; i < 7; i++) {
            const card = document.createElement('div');
            card.className = 'daily-card';
            const date = new Date(daily.time[i]);
            const tempMax = daily.temperature_2m_max[i];
            const tempMin = daily.temperature_2m_min[i];
            const code = daily.weathercode[i];
            const sunrise = new Date(daily.sunrise[i]);
            const sunset = new Date(daily.sunset[i]);
            const cloudCover = daily.cloudcover_mean[i];
            const icon = getWeatherIconAndDescription(code).icon;
            card.innerHTML = `
                <h3>${date.getMonth()+1}/${date.getDate()}</h3>
                <div class="icon">${icon}</div>
                <div>${tempMin}â„ƒ - ${tempMax}â„ƒ</div>
                <div>äº‘é‡ï¼š${cloudCover}%</div>
                <div>æ—¥å‡ºï¼š${formatNumber(sunrise.getHours())}:${formatNumber(sunrise.getMinutes())}</div>
                <div>æ—¥è½ï¼š${formatNumber(sunset.getHours())}:${formatNumber(sunset.getMinutes())}</div>
            `;
            card.addEventListener('click', () => {
                showHourlyForecastForDate(date);
            });
            dailyForecastDiv.appendChild(card);
        }
    }

    // æ˜¾ç¤ºæŒ‡å®šæ—¥æœŸçš„å°æ—¶å¤©æ°”é¢„æŠ¥
    function showHourlyForecastForDate(date) {
        updateHourlyForecast(hourlyData, date);
    }

    // æ ¼å¼åŒ–æ•°å­—ï¼Œç¡®ä¿ä¸¤ä½æ•°
    function formatNumber(num) {
        return num < 10 ? '0' + num : num;
    }

    // ========== æ—¥å‡ºæ—¥è½ç›¸å…³å‡½æ•° ==========

    // è·å–æ—¥å‡ºæ—¥è½æ—¶é—´
    function getSunTimes(lat, lon) {
        fetch(`https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lon}&formatted=0`)
            .then(response => response.json())
            .then(data => {
                const sunrise = new Date(data.results.sunrise);
                const sunset = new Date(data.results.sunset);
                sunriseTime = sunrise.getHours();
                sunsetTime = sunset.getHours();

                updateSunTimesUI(sunrise, sunset);
                determineTimePeriod();
                adjustWeatherCardBackground(weatherDescription.innerText);
            })
            .catch(error => {
                console.error('è·å–æ—¥å‡ºæ—¥è½æ—¶é—´å¤±è´¥ï¼š', error);
            });
    }

    // æ›´æ–°æ—¥å‡ºæ—¥è½ä¿¡æ¯UI
    function updateSunTimesUI(sunrise, sunset) {
        const sunriseStr = formatTime(sunrise);
        const sunsetStr = formatTime(sunset);
        const goldenHourStart = new Date(sunset.getTime() - 60 * 60000);
        const goldenHourEnd = sunset;
        const blueHourStart = sunset;
        const blueHourEnd = new Date(sunset.getTime() + 30 * 60000);

        sunriseSunset.innerHTML = `æ—¥å‡ºæ—¶é—´ï¼š${sunriseStr}<br>æ—¥è½æ—¶é—´ï¼š${sunsetStr}<br>é»„é‡‘æ—¶æ®µï¼š${formatTime(goldenHourStart)} - ${formatTime(goldenHourEnd)}<br>è“è°ƒæ—¶æ®µï¼š${formatTime(blueHourStart)} - ${formatTime(blueHourEnd)}`;
    }

    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(date) {
        let hours = date.getHours();
        let minutes = date.getMinutes();
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12; // 0ç‚¹æ˜¾ç¤ºä¸º12
        minutes = minutes < 10 ? '0' + minutes : minutes;
        return `${hours}:${minutes} ${ampm}`;
    }

    // ç¡®å®šå½“å‰æ—¶é—´æ®µ
    function determineTimePeriod() {
        const now = new Date();
        const currentTime = now.getHours() + now.getMinutes() / 60;
        const sunriseTimeDecimal = sunriseTime;
        const sunsetTimeDecimal = sunsetTime;
        const goldenHourStart = sunsetTimeDecimal - 1;
        const goldenHourEnd = sunsetTimeDecimal;
        const blueHourStart = sunsetTimeDecimal;
        const blueHourEnd = sunsetTimeDecimal + 0.5;

        if (currentTime >= sunriseTimeDecimal && currentTime < sunsetTimeDecimal) {
            timePeriod = 'day';
        } else {
            timePeriod = 'night';
        }

        if (currentTime >= goldenHourStart && currentTime < goldenHourEnd) {
            timePeriod = 'golden';
        }

        if (currentTime >= blueHourStart && currentTime < blueHourEnd) {
            timePeriod = 'blue';
        }
    }

    // ========== çµæ„Ÿç”Ÿæˆç›¸å…³å‡½æ•° ==========

    function generateInspiration() {
        const category = categorySelect.value;
        let data;

        if (category === 'all') {
            // åˆå¹¶æ‰€æœ‰åˆ†ç±»çš„è¯æ±‡åº“
            data = {
                subjects: [],
                actions: [],
                scenes: [],
                descriptors: []
            };

            for (let key in inspirationsData) {
                data.subjects = data.subjects.concat(inspirationsData[key].subjects);
                data.actions = data.actions.concat(inspirationsData[key].actions);
                data.scenes = data.scenes.concat(inspirationsData[key].scenes);
                data.descriptors = data.descriptors.concat(inspirationsData[key].descriptors);
            }
        } else {
            data = inspirationsData[category];
        }

        const subject = data.subjects[Math.floor(Math.random() * data.subjects.length)];
        const action = data.actions[Math.floor(Math.random() * data.actions.length)];
        const scene = data.scenes[Math.floor(Math.random() * data.scenes.length)];
        const descriptor = data.descriptors[Math.floor(Math.random() * data.descriptors.length)];

        return `æ‹æ‘„${descriptor}${scene}${action}çš„${subject}`;
    }

    generateBtn.addEventListener('click', () => {
        const inspiration = generateInspiration();

        // æ˜¾ç¤ºç­›å­åŠ¨ç”»
        dice.style.display = 'block';
        dice.style.animation = 'rotateDice 1s forwards';

        setTimeout(() => {
            dice.style.display = 'none';
            const inspirationInput = document.getElementById('inspiration-input');
            inspirationInput.value = inspiration;
            inspirationInput.classList.add('text-glow');
        }, 1000);
    });

    // æ”¶è—çµæ„Ÿ
    saveBtn.addEventListener('click', () => {
        const inspirationInput = document.getElementById('inspiration-input');
        const inspiration = inspirationInput.value.trim();
        if (inspiration) {
            savedInspirations.push(inspiration);
            updateSavedInspirations();
            alert('çµæ„Ÿå·²æ”¶è—ï¼');
        } else {
            alert('çµæ„Ÿå†…å®¹ä¸èƒ½ä¸ºç©ºï¼');
        }
    });

    // æ›´æ–°æ”¶è—çš„çµæ„Ÿåˆ—è¡¨
    function updateSavedInspirations() {
        savedInspirationsDiv.innerHTML = '<h3>å·²æ”¶è—çš„çµæ„Ÿ</h3>';
        savedInspirations.forEach((insp, index) => {
            const div = document.createElement('div');
            div.className = 'inspiration-item fade-in';
            div.innerHTML = `${insp}<button onclick="deleteInspiration(${index})">åˆ é™¤</button>`;
            savedInspirationsDiv.appendChild(div);

            // æ·»åŠ æ¸æ˜¾æ•ˆæœ
            setTimeout(() => {
                div.classList.add('show');
            }, 0);
        });
    }

    // åˆ é™¤æ”¶è—çš„çµæ„Ÿ
    function deleteInspiration(index) {
        const inspirationItems = document.querySelectorAll('.inspiration-item');
        inspirationItems[index].classList.add('fade-out');
        setTimeout(() => {
            savedInspirations.splice(index, 1);
            updateSavedInspirations();
        }, 500);
    }

    // åˆå§‹åŒ–æœ¬åœ°å­˜å‚¨çš„æ”¶è—
    function loadSavedInspirations() {
        const saved = localStorage.getItem('savedInspirations');
        if (saved) {
            savedInspirations = JSON.parse(saved);
            updateSavedInspirations();
        }
    }

    // ä¿å­˜æ”¶è—åˆ°æœ¬åœ°å­˜å‚¨
    window.addEventListener('beforeunload', () => {
        localStorage.setItem('savedInspirations', JSON.stringify(savedInspirations));
    });

    // ========== ç…§ç‰‡æœç´¢ç›¸å…³å‡½æ•° ==========

    function loadLocationPhotos(locationName) {
        const photoContainer = document.getElementById('photo-container');
        photoContainer.innerHTML = '<p>æ­£åœ¨åŠ è½½ç…§ç‰‡...</p>'; // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨

        fetch(`https://api.unsplash.com/search/photos?query=${encodeURIComponent(locationName)}&client_id=${unsplashAccessKey}`)
            .then(response => response.json())
            .then(data => {
                if (data.results && data.results.length > 0) {
                    displayPhotos(data.results);
                } else {
                    photoContainer.innerHTML = '<p>æœªæ‰¾åˆ°ç›¸å…³ç…§ç‰‡ã€‚</p>';
                }
            })
            .catch(error => {
                console.error('è·å–ç…§ç‰‡å¤±è´¥ï¼š', error);
                photoContainer.innerHTML = '<p>è·å–ç…§ç‰‡å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚</p>';
            });
    }

    function displayPhotos(photos) {
        const photoContainer = document.getElementById('photo-container');
        photoContainer.innerHTML = '';

        // åˆ›å»º IntersectionObserver å®ä¾‹
        const observer = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src;
                    observer.unobserve(img);
                }
            });
        });

        photos.forEach(photo => {
            const img = document.createElement('img');
            img.dataset.src = photo.urls.small;
            img.alt = photo.alt_description || 'ç›®çš„åœ°ç…§ç‰‡';
            img.title = photo.description || photo.alt_description || '';
            photoContainer.appendChild(img);

            // è§‚å¯Ÿå›¾ç‰‡å…ƒç´ 
            observer.observe(img);
        });
    }
</script>
</body>
</html>
